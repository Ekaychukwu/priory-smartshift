<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Priory SmartShift – Manager Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #111827;
      --bg-card: #020617;
      --border-subtle: rgba(148, 163, 184, 0.25);
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --accent-strong: #16a34a;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #ef4444;
      --danger-soft: rgba(239, 68, 68, 0.12);
      --warning: #f97316;
      --warning-soft: rgba(249, 115, 22, 0.12);
      --info-soft: rgba(59, 130, 246, 0.15);
      --radius-lg: 18px;
      --radius-xl: 26px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.75);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 24px;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      gap: 16px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 1.6rem;
      letter-spacing: 0.03em;
    }

    .title-block p {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.07);
      border: 1px solid rgba(34, 197, 94, 0.28);
      font-size: 0.8rem;
      color: var(--accent);
    }

    .badge span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.7);
    }

    button.primary {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      background: linear-gradient(to right, var(--accent), var(--accent-strong));
      color: #0b1120;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 12px 25px rgba(34, 197, 94, 0.45);
    }

    button.primary:hover {
      filter: brightness(1.05);
    }

    button.secondary {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.7);
      color: var(--text);
      cursor: pointer;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button.secondary:hover {
      border-color: rgba(148, 163, 184, 0.6);
    }

    .cards-grid {
      display: grid;
      grid-template-columns: 2.2fr 1.5fr;
      gap: 18px;
      margin-bottom: 18px;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9), var(--bg-card));
      border-radius: var(--radius-xl);
      padding: 18px 20px;
      border: 1px solid rgba(30, 64, 175, 0.45);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .card h2 {
      margin: 0;
      font-size: 1rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .card h3 {
      margin: 10px 0 6px;
      font-size: 0.9rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }

    .card .card-subtitle {
      margin: 4px 0 14px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border-subtle);
      font-size: 0.8rem;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill strong {
      color: var(--text);
    }

    .pill.bad {
      border-color: rgba(248, 113, 113, 0.7);
      background: var(--danger-soft);
      color: #fecaca;
    }

    .pill.good {
      border-color: rgba(52, 211, 153, 0.7);
      background: var(--accent-soft);
      color: #bbf7d0;
    }

    .stat-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin: 14px 0 8px;
    }

    .stat {
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid var(--border-subtle);
    }

    .stat-label {
      font-size: 0.78rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.13em;
    }

    .stat-value {
      margin-top: 4px;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .stat-value.bad {
      color: #fecaca;
    }

    .stat-value.good {
      color: #bbf7d0;
    }

    .date-label {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .table-wrapper {
      margin-top: 14px;
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      overflow: hidden;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9), #020617);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
    }

    thead {
      background: rgba(15, 23, 42, 0.9);
    }

    th,
    td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid rgba(30, 64, 175, 0.45);
    }

    th {
      font-weight: 500;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 0.75rem;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.75);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .status-open {
      background: var(--danger-soft);
      color: #fecaca;
      border: 1px solid rgba(248, 113, 113, 0.7);
    }

    .status-filled {
      background: var(--accent-soft);
      color: #bbf7d0;
      border: 1px solid rgba(52, 211, 153, 0.7);
    }

    .status-part {
      background: var(--warning-soft);
      color: #fed7aa;
      border: 1px solid rgba(249, 115, 22, 0.7);
    }

    .tag {
      display: inline-block;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      font-size: 0.7rem;
      color: var(--muted);
    }

    .error {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #fecaca;
      background: var(--danger-soft);
      border-radius: 10px;
      padding: 8px 10px;
    }

    .ok {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #bbf7d0;
      background: var(--accent-soft);
      border-radius: 10px;
      padding: 8px 10px;
    }

    .range-grid {
      display: grid;
      grid-template-columns: 2.1fr 1.3fr;
      gap: 18px;
      margin-bottom: 18px;
    }

    .range-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
      margin: 10px 0 8px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .field input {
      padding: 7px 9px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text);
      font-size: 0.8rem;
    }

    .field input:focus {
      outline: none;
      border-color: rgba(96, 165, 250, 0.8);
    }

    .attendance-grid {
      display: grid;
      grid-template-columns: 1.4fr 2fr;
      gap: 18px;
      margin-bottom: 18px;
    }

    .mini-stats {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-top: 10px;
    }

    .mini-stat {
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border-subtle);
      font-size: 0.78rem;
    }

    footer {
      margin-top: 20px;
      padding-top: 14px;
      border-top: 1px solid rgba(30, 64, 175, 0.45);
      font-size: 0.78rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }

    .ai-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--info-soft);
      border: 1px solid rgba(96, 165, 250, 0.7);
      font-size: 0.72rem;
      color: #bfdbfe;
    }

    .ai-chip span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #60a5fa;
      box-shadow: 0 0 10px rgba(96, 165, 250, 0.8);
    }

    /* AI assignment section */
    .assign-grid {
      display: grid;
      grid-template-columns: 1.4fr 2fr;
      gap: 18px;
    }

    .assign-shift-summary {
      font-size: 0.84rem;
      color: var(--muted);
      margin-top: 6px;
    }

    .assign-list {
      margin-top: 10px;
      max-height: 260px;
      overflow-y: auto;
      border-radius: 14px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      padding: 8px 10px;
    }

    .assign-item {
      padding: 8px 6px;
      border-bottom: 1px solid rgba(51, 65, 85, 0.85);
      font-size: 0.8rem;
    }

    .assign-item:last-child {
      border-bottom: none;
    }

    .assign-name-line {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6px;
    }

    .assign-name {
      font-weight: 500;
      color: var(--text);
    }

    .assign-score {
      font-size: 0.78rem;
      color: #bfdbfe;
    }

    .assign-meta {
      margin-top: 3px;
      font-size: 0.76rem;
      color: var(--muted);
    }

    .assign-reasons {
      margin-top: 3px;
      font-size: 0.76rem;
      color: #c4b5fd;
    }

    @media (max-width: 960px) {
      .cards-grid,
      .range-grid,
      .attendance-grid,
      .assign-grid {
        grid-template-columns: 1fr;
      }

      body {
        padding: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="title-block">
        <h1>Priory SmartShift</h1>
        <p>Live staffing, WhatsApp check-ins &amp; AI insight</p>
      </div>
      <div style="display:flex; align-items:center; gap:10px;">
        <div id="login-status" class="badge" style="display:none;">
          <span class="dot"></span>
          <span>Demo manager logged in</span>
        </div>
        <button id="demo-login-btn" class="primary">
          <span>Login as demo manager</span>
        </button>
      </div>
    </header>

    <!-- TODAY + AI INSIGHT -->
    <div class="cards-grid">
      <!-- Today live rota -->
      <section class="card">
        <h2>TODAY</h2>
        <p class="card-subtitle">Live view of today’s rota</p>

        <div class="pill-row">
          <div class="pill">
            <span id="today-date-label">–</span>
          </div>
        </div>

        <div class="stat-row">
          <div class="stat">
            <div class="stat-label">Shifts required</div>
            <div id="today-required" class="stat-value">–</div>
          </div>
          <div class="stat">
            <div class="stat-label">Shifts filled</div>
            <div id="today-filled" class="stat-value good">–</div>
          </div>
          <div class="stat">
            <div class="stat-label">Open positions</div>
            <div id="today-open" class="stat-value bad">–</div>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Ward</th>
                <th>Role</th>
                <th>Time</th>
                <th>Status</th>
                <th>Req</th>
                <th>Filled</th>
              </tr>
            </thead>
            <tbody id="today-shifts-body">
              <tr>
                <td colspan="6">Loading today’s shifts…</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div id="today-error" class="error" style="display:none;"></div>
      </section>

      <!-- AI Insight -->
      <section class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <h2>AI Insight</h2>
          <div class="ai-chip">
            <span class="dot"></span>
            <span>Staffing & wellbeing signal</span>
          </div>
        </div>

        <h3>AI forecast</h3>
        <p class="card-subtitle">High-level risk and open shift outlook.</p>

        <div class="stat-row">
          <div class="stat">
            <div class="stat-label">AI summary</div>
            <div id="ai-summary" class="stat-value">–</div>
          </div>
          <div class="stat">
            <div class="stat-label">Forecast date</div>
            <div id="ai-forecast-date" class="stat-value">–</div>
          </div>
          <div class="stat">
            <div class="stat-label">Expected open shifts</div>
            <div id="ai-expected-open" class="stat-value">–</div>
          </div>
        </div>

        <div id="ai-extra-text" class="ok" style="margin-top:14px;">
          Awaiting AI forecast…
        </div>
      </section>
    </div>

    <!-- DATE RANGE & WARD ANALYTICS -->
    <section class="card">
      <h2>DATE RANGE &amp; WARD ANALYTICS</h2>
      <p class="card-subtitle">Shift fill, WhatsApp activity &amp; attendance</p>

      <div class="range-filters">
        <div class="field">
          <label for="range-from">From</label>
          <input type="date" id="range-from" />
        </div>
        <div class="field">
          <label for="range-to">To</label>
          <input type="date" id="range-to" />
        </div>
        <button id="range-apply-btn" class="secondary">
          Apply range
        </button>
      </div>

      <div class="range-grid">
        <div>
          <h3>Shift fill by ward</h3>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Ward</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Req</th>
                  <th>Filled</th>
                </tr>
              </thead>
              <tbody id="range-shifts-body">
                <tr>
                  <td colspan="6">Loading shifts for range…</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="range-shifts-error" class="error" style="display:none;"></div>
        </div>

        <div>
          <h3>Check-in overview</h3>
          <div class="mini-stats">
            <div class="mini-stat">
              <div class="stat-label">Total check-ins</div>
              <div id="range-total-checkins" class="stat-value">–</div>
            </div>
            <div class="mini-stat">
              <div class="stat-label">From WhatsApp</div>
              <div id="range-whatsapp" class="stat-value">–</div>
            </div>
            <div class="mini-stat">
              <div class="stat-label">Other sources</div>
              <div id="range-other" class="stat-value">–</div>
            </div>
          </div>

          <h3 style="margin-top:16px;">Today – WhatsApp vs other</h3>
          <div id="today-attendance-summary" class="mini-stat">
            Loading today’s attendance…
          </div>
        </div>
      </div>
    </section>

    <!-- ATTENDANCE TABLES -->
    <div class="attendance-grid">
      <section class="card">
        <h2>Today’s attendance</h2>
        <p class="card-subtitle">Real-time check-ins for current date.</p>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>When</th>
                <th>Staff</th>
                <th>Action</th>
                <th>Source</th>
              </tr>
            </thead>
            <tbody id="attendance-today-body">
              <tr>
                <td colspan="4">Loading today’s attendance…</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div id="attendance-today-error" class="error" style="display:none;"></div>
      </section>

      <section class="card">
        <h2>Attendance logs (selected range)</h2>
        <p class="card-subtitle">Historical view of check-ins &amp; checkouts.</p>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>When</th>
                <th>Staff</th>
                <th>Action</th>
                <th>Source</th>
              </tr>
            </thead>
            <tbody id="attendance-range-body">
              <tr>
                <td colspan="4">Loading attendance logs…</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div id="attendance-range-error" class="error" style="display:none;"></div>
      </section>
    </div>

    <!-- AI SHIFT ASSIGNMENT (EXPERIMENTAL) -->
    <section class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <h2>AI SHIFT ASSIGNMENT (EXPERIMENTAL)</h2>
        <div class="ai-chip">
          <span class="dot"></span>
          <span>Ranking staff for a given shift</span>
        </div>
      </div>
      <p class="card-subtitle">
        Enter a shift ID from the rota to see AI-ranked staff recommendations based on
        contracts, ward familiarity, preferences, and safety rules.
      </p>

      <div class="assign-grid">
        <div>
          <h3>Input</h3>
          <div class="field">
            <label for="assign-shift-id">Shift ID</label>
            <input type="number" id="assign-shift-id" placeholder="e.g. 2" />
          </div>
          <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
            <button id="assign-fetch-btn" class="secondary">
              Get recommendations
            </button>
            <span style="font-size:0.78rem; color:var(--muted);">
              Tip: you can see shift IDs in the API or database (demo only).
            </span>
          </div>

          <div id="assign-error" class="error" style="display:none; margin-top:10px;"></div>
          <div id="assign-ok" class="ok" style="display:none; margin-top:10px;"></div>

          <div id="assign-shift-summary" class="assign-shift-summary"></div>
        </div>

        <div>
          <h3>Top recommended staff</h3>
          <div id="assign-top-list" class="assign-list">
            <div style="font-size:0.8rem; color:var(--muted);">
              No recommendations loaded yet. Enter a shift ID and click
              <strong>Get recommendations</strong>.
            </div>
          </div>

          <h3 style="margin-top:14px;">Full ranked list</h3>
          <div id="assign-full-list" class="assign-list">
            <div style="font-size:0.8rem; color:var(--muted);">
              Full ranking will appear here once a shift is analysed.
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer>
      <span>Priory SmartShift · Manager view</span>
      <span>Powered by The Labour Prefect</span>
    </footer>
  </div>

  <script>
    // ---------- BASIC HELPERS ----------
    function formatDate(dateStr) {
      if (!dateStr) return '–';
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return dateStr;
      return d.toISOString().slice(0, 10);
    }

    function formatTimeRange(row) {
      const start = row.start_time || row.start || row.from || row.startTime;
      const end = row.end_time || row.end || row.to || row.endTime;
      if (!start && !end) return '–';
      const s = start ? start.toString().slice(11, 16) : '–';
      const e = end ? end.toString().slice(11, 16) : '–';
      return s + '–' + e;
    }

    // Unwrap common API response shapes
    function unwrapData(raw) {
      if (!raw) return {};
      if (raw.data && typeof raw.data === 'object') return raw.data;
      return raw;
    }

    function extractRows(raw) {
      const data = unwrapData(raw);
      return (
        data.rows ||
        data.records ||
        data.shifts ||
        data.logs ||
        data.items ||
        []
      );
    }

    // GET with Authorization header using JWT stored in localStorage
    async function apiGet(url) {
      const token = localStorage.getItem('jwtToken');
      if (!token) {
        console.warn('No JWT token found in localStorage');
        throw new Error('MISSING_TOKEN');
      }

      const res = await fetch(url, {
        headers: {
          'Authorization': 'Bearer ' + token
        }
      });

      if (!res.ok) {
        let msg = 'HTTP ' + res.status;
        try {
          const errBody = await res.json();
          console.warn('API error body for', url, errBody);
          if (errBody && errBody.error) msg += ' – ' + errBody.error;
        } catch (_) {}
        throw new Error(msg);
      }

      const json = await res.json();
      console.log('API GET', url, '->', json);
      return json;
    }

    // ---------- GLOBAL CACHES FOR "AI" ----------
    let aiTodayShiftsRows = null;
    let aiRangeShiftsRows = null;
    let aiRangeAttendanceRows = null;

    // ---------- LOGIN HANDLING ----------
    function setLoggedInUI(isLoggedIn) {
      const badge = document.getElementById('login-status');
      const btn = document.getElementById('demo-login-btn');

      if (isLoggedIn) {
        if (badge) badge.style.display = 'inline-flex';
        if (btn) btn.style.display = 'none';
      } else {
        if (badge) badge.style.display = 'none';
        if (btn) btn.style.display = 'inline-flex';
      }
    }

    async function handleDemoLogin() {
      try {
        const res = await fetch('/api/debug/test-token');
        const data = await res.json();

        console.log('/api/debug/test-token ->', data);

        if (!data || !data.token) {
          alert('Could not obtain demo token from /api/debug/test-token');
          return;
        }

        localStorage.setItem('jwtToken', data.token);
        setLoggedInUI(true);

        await loadAllDashboardData();
      } catch (err) {
        console.error(err);
        alert('Error while logging in as demo manager');
      }
    }

    // ---------- TODAY SHIFTS ----------
    async function loadTodayShiftsAndStats() {
      const tbody = document.getElementById('today-shifts-body');
      const errBox = document.getElementById('today-error');
      const dateLabel = document.getElementById('today-date-label');
      const reqEl = document.getElementById('today-required');
      const filledEl = document.getElementById('today-filled');
      const openEl = document.getElementById('today-open');

      if (errBox) errBox.style.display = 'none';

      try {
        const raw = await apiGet('/api/manager/shifts/summary/today');
        console.log('Today shifts raw ->', raw);

        const rows = extractRows(raw);
        aiTodayShiftsRows = rows;

        const unwrapped = unwrapData(raw);
        const summary =
          unwrapped.summary || raw.summary || unwrapped.totals || raw.totals || {};

        if (dateLabel) {
          const dateVal =
            raw.date || unwrapped.date || new Date().toISOString();
          dateLabel.textContent = formatDate(dateVal);
        }

        let totalRequired = summary.total_required;
        let totalFilled = summary.total_filled;
        let totalOpen = summary.total_open;

        if (typeof totalRequired === 'undefined') {
          totalRequired = 0;
          totalFilled = 0;
          rows.forEach(r => {
            const req = r.required || r.required_count || r.number_required || r.req || 0;
            const filled = r.filled || r.filled_count || r.number_filled || 0;
            totalRequired += req;
            totalFilled += filled;
          });
          totalOpen = totalRequired - totalFilled;
        }

        if (reqEl) reqEl.textContent = totalRequired ?? 0;
        if (filledEl) filledEl.textContent = totalFilled ?? 0;
        if (openEl) openEl.textContent = totalOpen ?? 0;

        if (tbody) {
          tbody.innerHTML = '';
          if (!rows.length) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="6">No shifts found for today.</td>';
            tbody.appendChild(tr);
          } else {
            rows.forEach(r => {
              const tr = document.createElement('tr');

              const ward = r.ward_name || r.ward || r.wardId || '–';
              const role = r.role_required || r.role_name || r.role || '–';
              const statusRaw =
                r.status ||
                r.fill_status ||
                (r.number_filled >= r.number_required ? 'filled' : (r.number_filled > 0 ? 'partial' : 'open'));
              const required = r.required || r.required_count || r.number_required || r.req || 0;
              const filled = r.filled || r.filled_count || r.number_filled || 0;

              let statusClass = 'status-open';
              let statusLabel = 'OPEN';

              const status = (statusRaw || '').toString().toLowerCase();
              if (status === 'filled') {
                statusClass = 'status-filled';
                statusLabel = 'FILLED';
              } else if (status === 'partial' || status === 'part') {
                statusClass = 'status-part';
                statusLabel = 'PARTIAL';
              }

              tr.innerHTML = `
                <td>${ward}</td>
                <td>${role}</td>
                <td>${formatTimeRange(r)}</td>
                <td><span class="status-pill ${statusClass}">${statusLabel}</span></td>
                <td>${required}</td>
                <td>${filled}</td>
              `;
              tbody.appendChild(tr);
            });
          }
        }
      } catch (err) {
        console.error('Error loading today shifts', err);
        if (errBox) {
          if (err.message === 'MISSING_TOKEN') {
            errBox.textContent = 'Please click "Login as demo manager" to load today’s shifts.';
          } else {
            errBox.textContent = 'Failed to load today’s shifts: ' + err.message;
          }
          errBox.style.display = 'block';
        }
      }
    }

    // ---------- ATTENDANCE (TODAY & RANGE) ----------
    async function loadTodayAttendance() {
      const tbody = document.getElementById('attendance-today-body');
      const errBox = document.getElementById('attendance-today-error');
      const todaySummary = document.getElementById('today-attendance-summary');
      if (errBox) errBox.style.display = 'none';

      try {
        const raw = await apiGet('/api/manager/attendance/today');
        console.log('Today attendance raw ->', raw);

        const rows = extractRows(raw);

        if (tbody) {
          tbody.innerHTML = '';
          if (!rows.length) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="4">No attendance logs for today yet.</td>';
            tbody.appendChild(tr);
          } else {
            rows.forEach(r => {
              const tr = document.createElement('tr');
              const when =
                r.occurred_at ||
                r.created_at ||
                r.timestamp ||
                r.time ||
                new Date().toISOString();

              const staff =
                r.staff_name || r.staff || r.user_name || r.user || '–';

              const action =
                r.action || r.type || 'checkin';

              const source =
                r.source || r.channel || 'unknown';

              tr.innerHTML = `
                <td>${formatDate(when)} ${when.toString().slice(11, 16)}</td>
                <td>${staff}</td>
                <td>${action}</td>
                <td>${source}</td>
              `;
              tbody.appendChild(tr);
            });
          }
        }

        if (todaySummary) {
          let whatsappCount = 0;
          let otherCount = 0;
          rows.forEach(r => {
            const source =
              (r.source || r.channel || '').toString().toLowerCase();
            if (source.includes('whatsapp')) {
              whatsappCount++;
            } else {
              otherCount++;
            }
          });
          const total = rows.length;
          todaySummary.innerHTML = `
            <div class="stat-label">Today’s check-ins</div>
            <div class="stat-value">${total}</div>
            <div style="font-size:0.78rem; color:var(--muted); margin-top:4px;">
              WhatsApp: ${whatsappCount} · Other: ${otherCount}
            </div>
          `;
        }
      } catch (err) {
        console.error('Error loading today attendance', err);
        if (errBox) {
          if (err.message === 'MISSING_TOKEN') {
            errBox.textContent = 'Please click "Login as demo manager" to load today’s attendance.';
          } else {
            errBox.textContent =
              'Failed to load today’s attendance: ' + err.message;
          }
          errBox.style.display = 'block';
        }
      }
    }

    async function loadRangeAttendance(from, to) {
      const tbody = document.getElementById('attendance-range-body');
      const errBox = document.getElementById('attendance-range-error');
      if (errBox) errBox.style.display = 'none';

      try {
        const url =
          '/api/manager/attendance/range?from=' +
          encodeURIComponent(from) +
          '&to=' +
          encodeURIComponent(to);

        const raw = await apiGet(url);
        console.log('Range attendance raw ->', raw);

        const rows = extractRows(raw);
        aiRangeAttendanceRows = rows;

        if (tbody) {
          tbody.innerHTML = '';
          if (!rows.length) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="4">No attendance in this range.</td>';
            tbody.appendChild(tr);
          } else {
            rows.forEach(r => {
              const tr = document.createElement('tr');
              const when =
                r.occurred_at ||
                r.created_at ||
                r.timestamp ||
                r.time ||
                new Date().toISOString();

              const staff =
                r.staff_name || r.staff || r.user_name || r.user || '–';

              const action =
                r.action || r.type || 'checkin';

              const source =
                r.source || r.channel || 'unknown';

              tr.innerHTML = `
                <td>${formatDate(when)} ${when.toString().slice(11, 16)}</td>
                <td>${staff}</td>
                <td>${action}</td>
                <td>${source}</td>
              `;
              tbody.appendChild(tr);
            });
          }
        }
      } catch (err) {
        console.error('Error loading range attendance', err);
        if (errBox) {
          if (err.message === 'MISSING_TOKEN') {
            errBox.textContent = 'Please click "Login as demo manager" then re-apply the date range.';
          } else {
            errBox.textContent =
              'Failed to load attendance for range: ' + err.message;
          }
          errBox.style.display = 'block';
        }
      }
    }

    // ---------- RANGE SHIFTS + CHECK-IN OVERVIEW ----------
    async function loadRangeShiftsAndOverview(from, to) {
      const tbody = document.getElementById('range-shifts-body');
      const errBox = document.getElementById('range-shifts-error');
      const totalEl = document.getElementById('range-total-checkins');
      const waEl = document.getElementById('range-whatsapp');
      const otherEl = document.getElementById('range-other');

      if (errBox) errBox.style.display = 'none';

      try {
        const shiftUrl =
          '/api/manager/shifts/summary/range?from=' +
          encodeURIComponent(from) +
          '&to=' +
          encodeURIComponent(to);

        const shiftRaw = await apiGet(shiftUrl);
        console.log('Range shifts raw ->', shiftRaw);

        const rows = extractRows(shiftRaw);
        aiRangeShiftsRows = rows;

        if (tbody) {
          tbody.innerHTML = '';
          if (!rows.length) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="6">No shifts found in this range.</td>';
            tbody.appendChild(tr);
          } else {
            rows.forEach(r => {
              const tr = document.createElement('tr');
              const date = r.shift_date || r.date || r.day || new Date().toISOString();
              const ward = r.ward || r.ward_name || '–';
              const role = r.role_required || r.role_name || r.role || '–';
              const statusRaw =
                r.status ||
                r.fill_status ||
                (r.number_filled >= r.number_required ? 'filled' : (r.number_filled > 0 ? 'partial' : 'open'));
              const required = r.required || r.required_count || r.number_required || r.req || 0;
              const filled = r.filled || r.filled_count || r.number_filled || 0;

              let statusClass = 'status-open';
              let statusLabel = 'OPEN';
              const status = (statusRaw || '').toString().toLowerCase();
              if (status === 'filled') {
                statusClass = 'status-filled';
                statusLabel = 'FILLED';
              } else if (status === 'partial' || status === 'part') {
                statusClass = 'status-part';
                statusLabel = 'PARTIAL';
              }

              tr.innerHTML = `
                <td>${formatDate(date)}</td>
                <td>${ward}</td>
                <td>${role}</td>
                <td><span class="status-pill ${statusClass}">${statusLabel}</span></td>
                <td>${required}</td>
                <td>${filled}</td>
              `;
              tbody.appendChild(tr);
            });
          }
        }

        const attUrl =
          '/api/manager/attendance/range?from=' +
          encodeURIComponent(from) +
          '&to=' +
          encodeURIComponent(to);
        const attRaw = await apiGet(attUrl);
        console.log('Range attendance overview raw ->', attRaw);

        const logs = extractRows(attRaw);
        aiRangeAttendanceRows = logs;

        let whatsappCount = 0;
        let otherCount = 0;
        logs.forEach(r => {
          const source = (r.source || r.channel || '').toString().toLowerCase();
          if (source.includes('whatsapp')) {
            whatsappCount++;
          } else {
            otherCount++;
          }
        });
        const total = logs.length;

        if (totalEl) totalEl.textContent = total;
        if (waEl) waEl.textContent = whatsappCount;
        if (otherEl) otherEl.textContent = otherCount;
      } catch (err) {
        console.error('Error loading range data', err);
        if (errBox) {
          if (err.message === 'MISSING_TOKEN') {
            errBox.textContent = 'Please click "Login as demo manager" then re-apply the date range.';
          } else {
            errBox.textContent =
              'Failed to load shift/attendance overview: ' + err.message;
          }
          errBox.style.display = 'block';
        }
      }
    }

    // ---------- AI INSIGHT (COMPUTED ON FRONT-END) ----------
    function loadInsightToday() {
      const summaryEl = document.getElementById('ai-summary');
      const dateEl = document.getElementById('ai-forecast-date');
      const openEl = document.getElementById('ai-expected-open');
      const extraEl = document.getElementById('ai-extra-text');

      if (extraEl) extraEl.textContent = 'Computing AI forecast…';

      if (!aiTodayShiftsRows || !aiRangeShiftsRows) {
        if (summaryEl) summaryEl.textContent = 'No data yet';
        if (dateEl) dateEl.textContent = '–';
        if (openEl) openEl.textContent = '–';
        if (extraEl) extraEl.textContent = 'Waiting for shift & attendance data…';
        return;
      }

      const todayStr = new Date().toISOString().slice(0, 10);

      let todayOpenShortfall = 0;
      let overallOpenShortfall = 0;
      let latestDate = null;
      const wardOpenMap = {};

      const allShifts = [...aiRangeShiftsRows];
      aiTodayShiftsRows.forEach(r => allShifts.push(r));

      allShifts.forEach(r => {
        const dateVal = formatDate(r.shift_date || r.date || todayStr);
        const status = (r.status || '').toString().toLowerCase();
        const req = r.number_required || r.required || r.required_count || r.req || 0;
        const filled = r.number_filled || r.filled || r.filled_count || 0;
        const shortfall = Math.max(req - filled, 0);

        if (!latestDate || dateVal > latestDate) {
          latestDate = dateVal;
        }

        if (status === 'open' || shortfall > 0) {
          overallOpenShortfall += shortfall;
          if (dateVal === todayStr) {
            todayOpenShortfall += shortfall;
          }
          const ward = r.ward || r.ward_name || 'Unknown ward';
          wardOpenMap[ward] = (wardOpenMap[ward] || 0) + shortfall;
        }
      });

      let summaryText;
      if (overallOpenShortfall === 0) {
        summaryText = 'stable – no open shifts detected in range';
      } else if (overallOpenShortfall <= 3) {
        summaryText = 'caution – low level of open shifts';
      } else {
        summaryText = 'warning – significant open shift pressure';
      }

      if (summaryEl) summaryEl.textContent = summaryText;
      if (dateEl) dateEl.textContent = latestDate || '–';
      if (openEl) openEl.textContent = overallOpenShortfall;

      if (extraEl) {
        const burnoutWards = Object.entries(wardOpenMap)
          .filter(([, shortfall]) => shortfall >= 2)
          .map(([ward]) => ward);

        if (burnoutWards.length) {
          extraEl.innerHTML =
            '⚠️ Higher staffing strain in: <strong>' +
            burnoutWards.join(', ') +
            '</strong>. Today’s open shortfall: ' + todayOpenShortfall + '.';
        } else if (overallOpenShortfall > 0) {
          extraEl.textContent =
            'Some open shifts remain, but no single ward has repeated large gaps.';
        } else {
          extraEl.textContent =
            '✅ Staff wellbeing looks stable – no open shift gaps in the selected window.';
        }
      }
    }

    // ---------- AI ASSIGNMENT (REAL ENDPOINT) ----------
    function renderAssignmentResults(shift, top, all) {
      const summary = document.getElementById('assign-shift-summary');
      const topList = document.getElementById('assign-top-list');
      const fullList = document.getElementById('assign-full-list');

      if (summary) {
        if (!shift) {
          summary.textContent = 'No shift found for that ID.';
        } else {
          summary.textContent =
            `Shift ${shift.shift_ref || shift.id} · ` +
            `${shift.role_required || ''} · ` +
            `${shift.ward || ''} · ` +
            `${formatDate(shift.shift_date)} ` +
            `${(shift.start_time || '').toString().slice(0,5)}–` +
            `${(shift.end_time || '').toString().slice(0,5)}`;
        }
      }

      if (topList) {
        topList.innerHTML = '';
        if (!top || !top.length) {
          topList.innerHTML =
            '<div style="font-size:0.8rem; color:var(--muted);">No recommended staff found for this shift.</div>';
        } else {
          top.forEach(item => {
            const div = document.createElement('div');
            div.className = 'assign-item';
            const lastSeenStr = item.last_seen
              ? `${formatDate(item.last_seen)} ${item.last_seen.toString().slice(11,16)}`
              : 'no recent logs';

            div.innerHTML = `
              <div class="assign-name-line">
                <span class="assign-name">${item.staff_name}</span>
                <span class="assign-score">Score: ${item.score}</span>
              </div>
              <div class="assign-meta">
                Last seen: ${lastSeenStr} · Total check-ins: ${item.total_checkins}
              </div>
              <div class="assign-reasons">
                ${item.reasons && item.reasons.length ? item.reasons.join(' · ') : 'No specific reasons recorded'}
              </div>
            `;
            topList.appendChild(div);
          });
        }
      }

      if (fullList) {
        fullList.innerHTML = '';
        if (!all || !all.length) {
          fullList.innerHTML =
            '<div style="font-size:0.8rem; color:var(--muted);">No staff in ranking list.</div>';
        } else {
          all.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'assign-item';
            const lastSeenStr = item.last_seen
              ? `${formatDate(item.last_seen)} ${item.last_seen.toString().slice(11,16)}`
              : 'no recent logs';

            div.innerHTML = `
              <div class="assign-name-line">
                <span class="assign-name">#${index + 1} · ${item.staff_name}</span>
                <span class="assign-score">Score: ${item.score}</span>
              </div>
              <div class="assign-meta">
                Last seen: ${lastSeenStr} · Total check-ins: ${item.total_checkins}
              </div>
              <div class="assign-reasons">
                ${item.reasons && item.reasons.length ? item.reasons.join(' · ') : 'No specific reasons recorded'}
              </div>
            `;
            fullList.appendChild(div);
          });
        }
      }
    }

    function setupAiAssignmentSection() {
      const btn = document.getElementById('assign-fetch-btn');
      const input = document.getElementById('assign-shift-id');
      const errBox = document.getElementById('assign-error');
      const okBox = document.getElementById('assign-ok');

      if (!btn) return;

      btn.addEventListener('click', async () => {
        if (errBox) { errBox.style.display = 'none'; errBox.textContent = ''; }
        if (okBox) { okBox.style.display = 'none'; okBox.textContent = ''; }

        const topList = document.getElementById('assign-top-list');
        const fullList = document.getElementById('assign-full-list');
        const summary = document.getElementById('assign-shift-summary');

        if (topList) topList.innerHTML = '';
        if (fullList) fullList.innerHTML = '';
        if (summary) summary.textContent = '';

        const shiftId = input ? input.value.trim() : '';
        if (!shiftId) {
          if (errBox) {
            errBox.textContent = 'Please enter a shift ID.';
            errBox.style.display = 'block';
          }
          return;
        }

        try {
          const data = await apiGet('/api/ai/assign-shift/' + encodeURIComponent(shiftId));
          console.log('AI assign result ->', data);

          if (!data || data.error) {
            if (errBox) {
              errBox.textContent = data && data.error
                ? data.error
                : 'Failed to get assignment recommendations.';
              errBox.style.display = 'block';
            }
            return;
          }

          renderAssignmentResults(data.shift, data.top, data.all);

          if (okBox) {
            okBox.textContent = 'AI-ranked staff list loaded for shift ID ' + shiftId + '.';
            okBox.style.display = 'block';
          }
        } catch (err) {
          console.error('Error calling /api/ai/assign-shift', err);
          if (errBox) {
            if (err.message === 'MISSING_TOKEN') {
              errBox.textContent = 'Please click "Login as demo manager" before requesting recommendations.';
            } else {
              errBox.textContent = 'Error loading recommendations: ' + err.message;
            }
            errBox.style.display = 'block';
          }
        }
      });
    }

    // ---------- DATE RANGE DEFAULTS ----------
    function ensureDefaultRangeDates() {
      const fromInput = document.getElementById('range-from');
      const toInput = document.getElementById('range-to');
      const today = new Date();
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(today.getDate() - 6);

      const toStr = today.toISOString().slice(0, 10);
      const fromStr = sevenDaysAgo.toISOString().slice(0, 10);

      if (fromInput && !fromInput.value) fromInput.value = fromStr;
      if (toInput && !toInput.value) toInput.value = toStr;

      return { from: fromInput ? fromInput.value : fromStr, to: toInput ? toInput.value : toStr };
    }

    // ---------- MAIN LOADER ----------
    async function loadAllDashboardData() {
      const range = ensureDefaultRangeDates();

      await Promise.allSettled([
        loadTodayShiftsAndStats(),
        loadTodayAttendance(),
        loadRangeShiftsAndOverview(range.from, range.to),
        loadRangeAttendance(range.from, range.to)
      ]);

      loadInsightToday();
    }

    // ---------- INIT ----------
    document.addEventListener('DOMContentLoaded', () => {
      const loginBtn = document.getElementById('demo-login-btn');
      const rangeBtn = document.getElementById('range-apply-btn');

      if (loginBtn) {
        loginBtn.addEventListener('click', handleDemoLogin);
      }

      if (rangeBtn) {
        rangeBtn.addEventListener('click', async () => {
          const fromInput = document.getElementById('range-from');
          const toInput = document.getElementById('range-to');
          const from = fromInput && fromInput.value ? fromInput.value : null;
          const to = toInput && toInput.value ? toInput.value : null;

          if (!from || !to) {
            alert('Please select both From and To dates before applying the range.');
            return;
          }

          await Promise.allSettled([
            loadRangeShiftsAndOverview(from, to),
            loadRangeAttendance(from, to)
          ]);

          loadInsightToday();
        });
      }

      setupAiAssignmentSection();

      const existingToken = localStorage.getItem('jwtToken');
      if (existingToken) {
        setLoggedInUI(true);
        loadAllDashboardData().catch(err => console.error(err));
      } else {
        setLoggedInUI(false);
      }
    });
  </script>
</body>
</html>