<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Priory SmartShift – Manager dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020b1e;
      --bg-card: #020818;
      --border-soft: #1e293b;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.12);
      --accent-strong: rgba(34, 197, 94, 0.9);
      --danger-soft: rgba(248, 113, 113, 0.12);
      --danger: #f97373;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --chip: #020617;
      --chip-border: #1f2933;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.9);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 50%, #000 100%);
      color: var(--text);
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 20px 48px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .brand-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.9);
    }

    .brand-row span {
      font-size: 15px;
    }

    .brand-sub {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
      letter-spacing: 0.16em;
    }

    .top-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid var(--chip-border);
      background: rgba(15, 23, 42, 0.9);
      padding: 5px 10px;
      font-size: 11px;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #16a34a;
      box-shadow: 0 0 8px rgba(22, 163, 74, 0.8);
    }

    .btn {
      border-radius: 999px;
      padding: 5px 14px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: radial-gradient(circle at top left, #22c55e 0, #15803d 36%, #020617 100%);
      color: #e5fbea;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 25px rgba(34, 197, 94, 0.35);
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }

    .btn span {
      font-size: 13px;
      font-weight: 500;
    }

    .btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 14px 32px rgba(34, 197, 94, 0.5);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(148, 163, 184, 0.35);
      color: var(--text);
      box-shadow: 0 0 0 rgba(0, 0, 0, 0);
    }

    .btn-secondary:hover {
      background: rgba(15, 23, 42, 1);
      border-color: var(--accent-strong);
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .row {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 16px;
    }

    .card {
      background: radial-gradient(circle at top left, #020617 0, #020b1e 40%, #020617 100%);
      border-radius: 18px;
      border: 1px solid rgba(15, 23, 42, 0.95);
      box-shadow: var(--shadow-soft);
      padding: 14px 16px 12px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.08), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(34, 197, 94, 0.06), transparent 55%);
      opacity: 0.7;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
      gap: 12px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .card-header-right {
      text-align: right;
      font-size: 11px;
      color: var(--text-muted);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      padding: 3px 9px;
      font-size: 10px;
      background: rgba(15, 23, 42, 0.9);
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.7);
    }

    .metrics-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    .metric {
      border-radius: 14px;
      border: 1px solid rgba(30, 64, 175, 0.65);
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.95), #020617);
      padding: 8px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .metric-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .metric-value {
      font-size: 17px;
      font-weight: 600;
    }

    .metric-caption {
      font-size: 10px;
      color: var(--text-muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: var(--text-muted);
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #3b82f6;
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.7);
    }

    .ai-summary-text {
      font-size: 24px;
      font-weight: 600;
      text-transform: lowercase;
    }

    .ai-summary-text.neutral { color: #e5e7eb; }
    .ai-summary-text.warning { color: #facc15; }
    .ai-summary-text.risk { color: #f97373; }

    .ai-body {
      margin-top: 10px;
      font-size: 12px;
      line-height: 1.5;
      color: var(--text-muted);
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: linear-gradient(
        120deg,
        rgba(22, 163, 74, 0.08),
        rgba(15, 23, 42, 0.98)
      );
    }

    .table-container {
      margin-top: 8px;
      border-radius: 14px;
      border: 1px solid rgba(30, 64, 175, 0.65);
      background: rgba(15, 23, 42, 0.94);
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    thead {
      background: rgba(15, 23, 42, 0.98);
    }

    th, td {
      padding: 7px 9px;
      text-align: left;
      border-bottom: 1px solid rgba(15, 23, 42, 0.85);
    }

    th {
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-size: 10px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:nth-child(even) td {
      background: rgba(15, 23, 42, 0.92);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.13em;
    }

    .status-open {
      background: var(--danger-soft);
      color: var(--danger);
      border: 1px solid rgba(248, 113, 113, 0.55);
    }

    .status-filled {
      background: var(--accent-soft);
      color: var(--accent-strong);
      border: 1px solid rgba(34, 197, 94, 0.7);
    }

    .status-part {
      background: rgba(234, 179, 8, 0.15);
      color: #fbbf24;
      border: 1px solid rgba(234, 179, 8, 0.6);
    }

    .error-text {
      font-size: 11px;
      color: #fecaca;
      padding: 6px 10px 8px;
    }

    .helper-text {
      font-size: 11px;
      color: var(--text-muted);
      padding: 3px 2px 0;
    }

    .range-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .range-controls label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .range-controls input[type="date"] {
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 999px;
      padding: 4px 9px;
      color: var(--text);
      font-size: 11px;
    }

    .footer {
      margin-top: 24px;
      padding-top: 10px;
      border-top: 1px solid rgba(31, 41, 55, 0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-muted);
    }

    .footer span strong {
      color: #e5e7eb;
    }

    .footer-badge {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 4px 10px;
      background: rgba(15, 23, 42, 0.96);
    }

    @media (max-width: 900px) {
      .row {
        grid-template-columns: minmax(0, 1fr);
      }
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      .top-controls {
        align-self: stretch;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="brand">
        <div class="brand-row">
          <div class="brand-dot"></div>
          <span>PRIORY SMARTSHIFT</span>
        </div>
        <div class="brand-sub">Live staffing, WhatsApp check-ins & AI insight</div>
      </div>
      <div class="top-controls">
        <div class="chip" id="managerStatusChip">
          <div class="chip-dot"></div>
          <span>Manager not logged in</span>
        </div>
        <button id="demoLoginBtn" class="btn" type="button">
          <span>Login as demo manager</span>
        </button>
      </div>
    </header>

    <main>
      <div class="row">
        <!-- TODAY CARD -->
        <section class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Today</div>
                <div class="card-subtitle" id="todayDateLabel">
                  Live view of today's rota
                </div>
              </div>
              <div class="card-header-right">
                <div class="pill">
                  <span style="width:7px;height:7px;border-radius:999px;background:#22c55e;box-shadow:0 0 10px rgba(34,197,94,0.75);"></span>
                  <span>Live refresh</span>
                </div>
              </div>
            </div>

            <div class="metrics-row">
              <div class="metric">
                <div class="metric-label">Shifts required</div>
                <div class="metric-value" id="todayShiftsRequired">–</div>
                <div class="metric-caption">All wards</div>
              </div>
              <div class="metric">
                <div class="metric-label">Shifts filled</div>
                <div class="metric-value" id="todayShiftsFilled">–</div>
                <div class="metric-caption">Confirmed staff</div>
              </div>
              <div class="metric">
                <div class="metric-label">Open positions</div>
                <div class="metric-value" id="todayShiftsOpen">–</div>
                <div class="metric-caption">Still to cover</div>
              </div>
            </div>

            <div class="metrics-row">
              <div class="metric">
                <div class="metric-label">Check-ins (today)</div>
                <div class="metric-value" id="todayCheckinsTotal">–</div>
                <div class="metric-caption">
                  WhatsApp + other sources
                </div>
              </div>
              <div class="metric">
                <div class="metric-label">From WhatsApp</div>
                <div class="metric-value" id="todayCheckinsWhatsApp">–</div>
                <div class="metric-caption">SmartShift chatbot</div>
              </div>
              <div class="metric">
                <div class="metric-label">Other sources</div>
                <div class="metric-value" id="todayCheckinsOther">–</div>
                <div class="metric-caption">Manual / HRIS</div>
              </div>
            </div>

            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Ward</th>
                    <th>Role</th>
                    <th>Time</th>
                    <th>Status</th>
                    <th>Req</th>
                    <th>Filled</th>
                  </tr>
                </thead>
                <tbody id="todayTableBody">
                  <tr>
                    <td colspan="6" style="padding:8px 10px;color:#9ca3af;">
                      Loading today’s data…
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="helper-text" id="todayHelperText">
              Live fill for today’s rota. Check console if errors appear.
            </div>
          </div>
        </section>

        <!-- AI INSIGHT CARD -->
        <section class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">AI insight</div>
                <div class="card-subtitle">
                  Staffing & wellbeing signal
                </div>
              </div>
              <div class="card-header-right">
                <div class="badge">
                  <div class="badge-dot"></div>
                  <span>AI forecast</span>
                </div>
              </div>
            </div>

            <div class="metrics-row">
              <div class="metric">
                <div class="metric-label">AI summary</div>
                <div class="ai-summary-text neutral" id="aiSummaryText">
                  Loading…
                </div>
              </div>
              <div class="metric">
                <div class="metric-label">Forecast date</div>
                <div class="metric-value" id="aiForecastDate">–</div>
                <div class="metric-caption">
                  Next rota / risk window
                </div>
              </div>
              <div class="metric">
                <div class="metric-label">Expected open shifts</div>
                <div class="metric-value" id="aiExpectedOpen">–</div>
                <div class="metric-caption">
                  Predicted uncovered posts
                </div>
              </div>
            </div>

            <div class="ai-body" id="aiBodyText">
              Fetching AI forecast…
            </div>
          </div>
        </section>
      </div>

      <!-- RANGE & ATTENDANCE CARD -->
      <section class="card">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="card-title">Date range & ward analytics</div>
              <div class="card-subtitle">
                Shift fill, WhatsApp activity & attendance
              </div>
            </div>
            <div class="card-header-right">
              <span class="card-subtitle">Manager view · all wards</span>
            </div>
          </div>

          <div class="range-controls">
            <label>
              From
              <input type="date" id="rangeFrom" />
            </label>
            <label>
              To
              <input type="date" id="rangeTo" />
            </label>
            <button id="applyRangeBtn" class="btn-secondary btn" type="button">
              <span>Apply range</span>
            </button>
            <span id="rangeStatusText" class="card-subtitle"></span>
          </div>

          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Ward</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Req</th>
                  <th>Filled</th>
                </tr>
              </thead>
              <tbody id="rangeShiftBody">
                <tr>
                  <td colspan="6" style="padding:8px 10px;color:#9ca3af;">
                    Select a date range then click “Apply range” to load shift fill.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="metrics-row" style="margin-top: 10px;">
            <div class="metric">
              <div class="metric-label">Total check-ins (range)</div>
              <div class="metric-value" id="rangeCheckinsTotal">–</div>
              <div class="metric-caption">
                WhatsApp + other sources
              </div>
            </div>
            <div class="metric">
              <div class="metric-label">From WhatsApp</div>
              <div class="metric-value" id="rangeCheckinsWhatsApp">–</div>
              <div class="metric-caption">
                SmartShift chatbot
              </div>
            </div>
            <div class="metric">
              <div class="metric-label">Other sources</div>
              <div class="metric-value" id="rangeCheckinsOther">–</div>
              <div class="metric-caption">
                Manual / HRIS
              </div>
            </div>
          </div>

          <div class="table-container" style="margin-top: 10px;">
            <table>
              <thead>
                <tr>
                  <th>When</th>
                  <th>Staff</th>
                  <th>Action</th>
                  <th>Source</th>
                </tr>
              </thead>
              <tbody id="rangeAttendanceBody">
                <tr>
                  <td colspan="4" style="padding:8px 10px;color:#9ca3af;">
                    Select a range to view attendance logs.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="helper-text" id="rangeHelperText">
            Range analytics show how well shifts were covered and where WhatsApp
            self-service is being used.
          </div>
        </div>
      </section>

      <footer class="footer">
        <span>
          © <strong id="footerYear"></strong> Powered by
          <strong>The Labour Prefect</strong>. Priory SmartShift demo environment.
        </span>
        <span class="footer-badge">
          Staffing intelligence · WhatsApp check-ins · Rota optimisation
        </span>
      </footer>
    </main>
  </div>

  <script>
    // -------------------------------
    // Small helpers
    // -------------------------------
    function setText(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }

    function formatDateFriendly(iso) {
      if (!iso) return "–";
      const d = new Date(iso);
      return d.toLocaleDateString("en-GB", {
        weekday: "short",
        day: "2-digit",
        month: "short",
        year: "numeric",
      });
    }

    function formatTimeLabel(start, end) {
      if (!start || !end) return "–";
      const s = String(start).slice(0, 5);
      const e = String(end).slice(0, 5);
      return s + "–" + e;
    }

    function todayISO() {
      const d = new Date();
      return d.toISOString().slice(0, 10);
    }

    function firstOfMonthISO() {
      const d = new Date();
      d.setDate(1);
      return d.toISOString().slice(0, 10);
    }

    // -------------------------------
    // Auth & fetch wrapper
    // -------------------------------
    async function demoLogin(force) {
      const statusChip = document.getElementById("managerStatusChip");
      const btn = document.getElementById("demoLoginBtn");

      if (!force) {
        const existing = localStorage.getItem("managerToken");
        if (existing) {
          if (statusChip) {
            statusChip.querySelector("span").textContent = "Demo manager logged in";
          }
          if (btn) {
            btn.textContent = "Demo manager logged in";
            btn.disabled = true;
          }
          return existing;
        }
      }

      try {
        const res = await fetch("/api/auth/demo-manager-login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
        });
        if (!res.ok) {
          throw new Error("Demo login failed: " + res.status);
        }
        const data = await res.json();
        localStorage.setItem("managerToken", data.token || "");
        if (statusChip) {
          statusChip.querySelector("span").textContent = "Demo manager logged in";
        }
        if (btn) {
          btn.textContent = "Demo manager logged in";
          btn.disabled = true;
        }
        return data.token;
      } catch (err) {
        console.error("[AUTH] Demo login error:", err);
        if (statusChip) {
          statusChip.querySelector("span").textContent =
            "Error logging in – see console";
        }
        throw err;
      }
    }

    async function fetchWithAuth(path, options = {}) {
      const token = localStorage.getItem("managerToken");
      if (!token) {
        throw new Error("No manager token in localStorage");
      }
      const res = await fetch(path, {
        ...options,
        headers: {
          ...(options.headers || {}),
          Authorization: "Bearer " + token,
        },
      });
      if (!res.ok) {
        const text = await res.text();
        console.error("[API] Request failed", path, res.status, text);
        throw new Error("Request failed " + res.status);
      }
      return res.json();
    }

    // -------------------------------
    // Load TODAY summary
    // -------------------------------
    async function loadTodaySummary() {
      setText("todayHelperText", "Loading today’s data…");
      setText("todayShiftsRequired", "–");
      setText("todayShiftsFilled", "–");
      setText("todayShiftsOpen", "–");

      try {
        const data = await fetchWithAuth("/api/manager/shifts/summary/today");
        console.log("[DASHBOARD] Today summary:", data);

        const items = data.items || [];
        let required = 0;
        let filled = 0;

        for (const row of items) {
          required += Number(row.number_required || 0);
          filled += Number(row.number_filled || 0);
        }

        const open = Math.max(required - filled, 0);

        setText("todayShiftsRequired", required || "0");
        setText("todayShiftsFilled", filled || "0");
        setText("todayShiftsOpen", open || "0");

        const tbody = document.getElementById("todayTableBody");
        if (!tbody) return;

        if (!items.length) {
          tbody.innerHTML =
            '<tr><td colspan="6" style="padding:8px 10px;color:#9ca3af;">No shifts found for today.</td></tr>';
        } else {
          tbody.innerHTML = "";
          for (const row of items) {
            const tr = document.createElement("tr");

            const status = String(row.status || "").toLowerCase();
            let statusClass = "status-open";
            let statusLabel = status || "open";
            if (status === "filled") statusClass = "status-filled";
            if (status === "partial" || status === "part") {
              statusClass = "status-part";
              statusLabel = "partial";
            }

            tr.innerHTML = `
              <td>${row.ward || "-"}</td>
              <td>${row.role_required || "-"}</td>
              <td>${formatTimeLabel(row.start_time, row.end_time)}</td>
              <td>
                <span class="status-pill ${statusClass}">
                  ${statusLabel}
                </span>
              </td>
              <td>${row.number_required ?? "-"}</td>
              <td>${row.number_filled ?? "-"}</td>
            `;
            tbody.appendChild(tr);
          }
        }

        setText(
          "todayHelperText",
          "Live view of today’s rota. Data shown for organisation " +
            (data.organisation_id ?? "–") +
            "."
        );
      } catch (err) {
        console.error("[DASHBOARD] Error loading today summary:", err);
        setText(
          "todayHelperText",
          "Error loading today’s data. See console for details."
        );
        const tbody = document.getElementById("todayTableBody");
        if (tbody) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="error-text">Error loading today’s shift data. Check browser console for details.</td></tr>';
        }
      }
    }

    // -------------------------------
    // Load TODAY attendance
    // -------------------------------
    async function loadTodayAttendance() {
      try {
        const data = await fetchWithAuth("/api/manager/attendance/today");
        console.log("[DASHBOARD] Today attendance:", data);

        const items = data.items || [];
        const total = items.length;
        const fromWhatsApp = items.filter(
          (x) => String(x.source || "").toLowerCase() === "whatsapp"
        ).length;
        const other = total - fromWhatsApp;

        setText("todayCheckinsTotal", total || "0");
        setText("todayCheckinsWhatsApp", fromWhatsApp || "0");
        setText("todayCheckinsOther", other || "0");
      } catch (err) {
        console.error("[DASHBOARD] Error loading today attendance:", err);
        setText("todayCheckinsTotal", "–");
        setText("todayCheckinsWhatsApp", "–");
        setText("todayCheckinsOther", "–");
      }
    }

    // -------------------------------
    // Load AI INSIGHT
    // -------------------------------
    async function loadAiInsight() {
      setText("aiSummaryText", "Loading…");
      setText("aiForecastDate", "–");
      setText("aiExpectedOpen", "–");
      document.getElementById("aiBodyText").textContent =
        "Fetching AI forecast…";

      try {
        const data = await fetchWithAuth("/api/test/ai/insight");
        console.log("[DASHBOARD] AI insight:", data);

        const summary = (data.summary || "neutral").toLowerCase();
        const details = data.details || {};
        const forecastDate = details.forecast_date || todayISO();
        const expectedOpen = details.expected_open_shifts ?? "0";

        const summaryEl = document.getElementById("aiSummaryText");
        summaryEl.textContent = summary;
        summaryEl.classList.remove("neutral", "warning", "risk");
        if (summary === "neutral") summaryEl.classList.add("neutral");
        else if (summary === "warning") summaryEl.classList.add("warning");
        else summaryEl.classList.add("risk");

        setText("aiForecastDate", formatDateFriendly(forecastDate));
        setText("aiExpectedOpen", expectedOpen);

        const burnoutAlerts = details.burnout_alerts || [];
        const aiBody = document.getElementById("aiBodyText");
        if (!burnoutAlerts.length) {
          aiBody.textContent =
            "No current burnout alerts flagged. Keep monitoring staffing balance across wards.";
        } else {
          const wards = burnoutAlerts.map((b) => b.ward || "Unknown").join(", ");
          aiBody.textContent =
            "Burnout risk flagged in: " +
            wards +
            ". Consider reallocating staff or reducing back-to-back long days.";
        }
      } catch (err) {
        console.error("[DASHBOARD] Error loading AI insight:", err);
        const aiBody = document.getElementById("aiBodyText");
        aiBody.textContent =
          "Unable to load AI forecast right now. Please check your connection or try again later.";
        setText("aiSummaryText", "error");
      }
    }

    // -------------------------------
    // Range analytics (shifts + attendance)
    // -------------------------------
    async function loadRangeAnalytics() {
      const fromInput = document.getElementById("rangeFrom");
      const toInput = document.getElementById("rangeTo");
      const from = fromInput.value;
      const to = toInput.value;
      const statusEl = document.getElementById("rangeStatusText");

      if (!from || !to) {
        statusEl.textContent = "Please choose both a start and end date.";
        return;
      }

      statusEl.textContent = "Loading range analytics…";

      const shiftBody = document.getElementById("rangeShiftBody");
      const attBody = document.getElementById("rangeAttendanceBody");
      shiftBody.innerHTML =
        '<tr><td colspan="6" style="padding:8px 10px;color:#9ca3af;">Loading shift data…</td></tr>';
      attBody.innerHTML =
        '<tr><td colspan="4" style="padding:8px 10px;color:#9ca3af;">Loading attendance data…</td></tr>';

      try {
        const [shiftData, attData] = await Promise.all([
          fetchWithAuth(
            `/api/manager/shifts/summary/range?from=${from}&to=${to}`
          ),
          fetchWithAuth(
            `/api/manager/attendance/range?from=${from}&to=${to}`
          ),
        ]);

        console.log("[DASHBOARD] Range shifts:", shiftData);
        console.log("[DASHBOARD] Range attendance:", attData);

        const shiftItems = shiftData.items || [];
        if (!shiftItems.length) {
          shiftBody.innerHTML =
            '<tr><td colspan="6" style="padding:8px 10px;color:#9ca3af;">No shifts found in this range.</td></tr>';
        } else {
          shiftBody.innerHTML = "";
          for (const row of shiftItems) {
            const tr = document.createElement("tr");
            const status = String(row.status || "").toLowerCase();
            let statusClass = "status-open";
            let statusLabel = status || "open";
            if (status === "filled") statusClass = "status-filled";
            if (status === "partial" || status === "part") {
              statusClass = "status-part";
              statusLabel = "partial";
            }

            tr.innerHTML = `
              <td>${formatDateFriendly(row.shift_date)}</td>
              <td>${row.ward || "-"}</td>
              <td>${row.role_required || "-"}</td>
              <td>
                <span class="status-pill ${statusClass}">
                  ${statusLabel}
                </span>
              </td>
              <td>${row.number_required ?? "-"}</td>
              <td>${row.number_filled ?? "-"}</td>
            `;
            shiftBody.appendChild(tr);
          }
        }

        const attItems = attData.items || [];
        if (!attItems.length) {
          attBody.innerHTML =
            '<tr><td colspan="4" style="padding:8px 10px;color:#9ca3af;">No attendance logs in this range.</td></tr>';
        } else {
          attBody.innerHTML = "";
          for (const row of attItems) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${new Date(row.occurred_at).toLocaleString("en-GB", {
                weekday: "short",
                day: "2-digit",
                month: "short",
                hour: "2-digit",
                minute: "2-digit",
              })}</td>
              <td>${row.staff_name || "Unknown staff"}</td>
              <td>${row.action || "-"}</td>
              <td>${row.source || "-"}</td>
            `;
            attBody.appendChild(tr);
          }
        }

        const totalAtt = attItems.length;
        const fromWhatsApp = attItems.filter(
          (x) => String(x.source || "").toLowerCase() === "whatsapp"
        ).length;
        const other = totalAtt - fromWhatsApp;

        setText("rangeCheckinsTotal", totalAtt || "0");
        setText("rangeCheckinsWhatsApp", fromWhatsApp || "0");
        setText("rangeCheckinsOther", other || "0");

        statusEl.textContent =
          "Showing " +
          shiftItems.length +
          " shift(s) and " +
          totalAtt +
          " attendance log(s) for the selected range.";
      } catch (err) {
        console.error("[DASHBOARD] Error loading range analytics:", err);
        statusEl.textContent =
          "Error loading range analytics. See console for details.";
        shiftBody.innerHTML =
          '<tr><td colspan="6" class="error-text">Error loading shift data.</td></tr>';
        attBody.innerHTML =
          '<tr><td colspan="4" class="error-text">Error loading attendance data.</td></tr>';
        setText("rangeCheckinsTotal", "–");
        setText("rangeCheckinsWhatsApp", "–");
        setText("rangeCheckinsOther", "–");
      }
    }

    // -------------------------------
    // Initialise everything
    // -------------------------------
    document.addEventListener("DOMContentLoaded", async () => {
      // Footer year + today label
      setText("footerYear", new Date().getFullYear().toString());
      setText("todayDateLabel", "Fri, " + formatDateFriendly(todayISO()));

      // Default date range: first of this month to today
      const fromInput = document.getElementById("rangeFrom");
      const toInput = document.getElementById("rangeTo");
      if (fromInput && toInput) {
        fromInput.value = firstOfMonthISO();
        toInput.value = todayISO();
      }

      // Button handler
      const btn = document.getElementById("demoLoginBtn");
      if (btn) {
        btn.addEventListener("click", async () => {
          try {
            await demoLogin(true);
            await Promise.all([
              loadTodaySummary(),
              loadTodayAttendance(),
              loadAiInsight(),
              loadRangeAnalytics(),
            ]);
          } catch (_) {
            // errors already logged
          }
        });
      }

      // Auto-login once if token already exists (or first load)
      try {
        await demoLogin(false);
        await Promise.all([
          loadTodaySummary(),
          loadTodayAttendance(),
          loadAiInsight(),
          loadRangeAnalytics(),
        ]);
      } catch (err) {
        console.error("[DASHBOARD] Initial load error:", err);
      }
    });
  </script>
</body>
</html>
