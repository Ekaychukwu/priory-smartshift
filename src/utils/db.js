const fs = require('fs');
const path = require('path');

// Path to the JSON file where our data is persisted.  The JSON file sits one
// level up from the `src` directory so that it is included when the project
// folder is compressed for delivery.
const dbPath = path.join(__dirname, '../../database.json');

// Default structure of the database.  If `database.json` does not exist
// at startup, this object will be written to disk.  You can pre-populate
// sample records here for testing purposes.
const defaultData = {
  // Organisations table defines each tenant.  Use subdomain to look
  // up organisation context when users log in.  At least one
  // organisation (id=1) is required for multi‑tenant mode.
  organisations: [
    {
      id: 1,
      name: 'Priory Group',
      subdomain: 'priory',
      address: '123 Priory Road, London',
      contact_email: 'admin@priory.com',
      created_at: new Date().toISOString()
    }
  ],
  // Billing details per organisation.  Populated when payroll and
  // performance metrics are generated.  Plan types: basic, pro, premium.
  organisation_billing: [
    {
      organisation_id: 1,
      plan_type: 'basic',
      active_users: 0,
      monthly_hours_logged: 0,
      total_cost: 0,
      next_billing_date: new Date().toISOString().split('T')[0]
    }
  ],
  shifts: [
    {
      id: 1,
      shift_ref: 'SH001',
      ward: 'Cardiology',
      role_required: 'Nurse',
      status: 'Open',
      shift_date: '2025-11-10T08:00:00Z',
      number_required: 2,
      number_filled: 0
      ,organisation_id: 1
    },
    {
      id: 2,
      shift_ref: 'SH002',
      ward: 'Oncology',
      role_required: 'Doctor',
      status: 'Open',
      shift_date: '2025-11-11T20:00:00Z',
      number_required: 1,
      number_filled: 0
      ,organisation_id: 1
    }
  ],
  staff: [
    {
      id: 1,
      name: 'Alice Example',
      phone_number: '+447700900001',
      preferred_shift: 'Day',
      wellbeing_score: 0,
      // Default contracted hours per week used for overtime calculations.
      // Updated to 37.5 to reflect a 37.5 hour work week.
      contracted_hours_per_week: 37.5
      ,organisation_id: 1
    },
    {
      id: 2,
      name: 'Bob Example',
      phone_number: '+447700900002',
      preferred_shift: 'Night',
      wellbeing_score: 0,
      contracted_hours_per_week: 37.5
      ,organisation_id: 1
    }
  ],
  wellbeing_logs: [],
  // Records of which staff accepted which shift, along with timestamp
  shift_assignments: []
  ,
  // Registered users for authentication.  Each user may be linked to a staff
  // record via the `staff_id` field.  Passwords are stored as
  // salted hashes generated by the `hashPassword` helper.
  users: [
    // Example admin account: email admin@example.com, password adminpass
    // The password hash will be generated at runtime if not present.
    {
      id: 1,
      name: 'Alice Admin',
      email: 'admin@example.com',
      password_hash: '',
      role: 'admin',
      staff_id: 1,
      organisation_id: 1
    },
    // Example staff account
    {
      id: 2,
      name: 'Bob Staff',
      email: 'staff@example.com',
      password_hash: '',
      role: 'staff',
      staff_id: 2,
      organisation_id: 1
    }
  ],
  // Daily wellbeing summaries generated by the AI engine.  Each record
  // contains a staff_id, summary, score and date (YYYY-MM-DD).
  wellbeing_summaries: [],
  // Payroll records for completed shifts.  Each record captures the
  // hours worked, pay rates, overtime and totals for a given pay period.
  payroll_records: [],
  // Performance metrics for each staff member on a given day.  These
  // metrics can be updated externally or via future integrations.
  performance_metrics: []
  ,
  // Reports generated for compliance and wellbeing.  Each record
  // references an organisation and stores metadata about the file.
  reports: []
  ,
  // Analytics snapshots store daily/weekly aggregated metrics used by the
  // predictive analytics module.  Each snapshot represents the state
  // of an organisation on a given date.
  analytics_snapshots: []
};

// Holds the in-memory copy of the database.  All modifications should
// operate on this object.  Changes are persisted to disk using the
// `save()` function.
let db = {};

// Load the database from disk.  If the file does not exist, write
// `defaultData` to disk and use that as the starting state.
function load() {
  if (!fs.existsSync(dbPath)) {
    fs.writeFileSync(dbPath, JSON.stringify(defaultData, null, 2));
    db = JSON.parse(JSON.stringify(defaultData));
    return;
  }
  const raw = fs.readFileSync(dbPath, 'utf8');
  try {
    db = JSON.parse(raw);
  } catch (err) {
    console.error('Failed to parse database.json. Recreating with default data.', err);
    db = JSON.parse(JSON.stringify(defaultData));
    fs.writeFileSync(dbPath, JSON.stringify(db, null, 2));
  }
}

// Persist the in-memory `db` object to disk.
function save() {
  fs.writeFileSync(dbPath, JSON.stringify(db, null, 2));
}

// Find a record by a given field and value.  Returns the first matching
// element or undefined.
function findRecord(collection, field, value) {
  return db[collection].find(item => item[field] === value);
}

// Return the entire dataset for a collection.
function getAll(collection) {
  return db[collection];
}

// Insert a new record into a collection.  Automatically assigns a new
// incremental `id` based on the highest existing id.
function insertRecord(collection, record) {
  const items = db[collection];
  const newId = items.length > 0 ? Math.max(...items.map(i => i.id)) + 1 : 1;
  const newRecord = { id: newId, ...record };
  items.push(newRecord);
  save();
  return newRecord;
}

// Update an existing record by id.  Returns the updated record, or
// undefined if not found.
function updateRecord(collection, id, updates) {
  const items = db[collection];
  const index = items.findIndex(item => String(item.id) === String(id));
  if (index === -1) return undefined;
  items[index] = { ...items[index], ...updates };
  save();
  return items[index];
}

// Remove a record by id.  Returns true if removed, false if not found.
function removeRecord(collection, id) {
  const items = db[collection];
  const index = items.findIndex(item => String(item.id) === String(id));
  if (index === -1) return false;
  items.splice(index, 1);
  save();
  return true;
}

// Initialize database on module load.
load();

// After loading the database, ensure that any users with blank password_hash
// fields are initialised with a deterministic hashed password.  The
// corresponding plain‑text passwords are commented in the defaultData.
(() => {
  try {
    const { hashPassword } = require('./auth');
    // Ensure the users and wellbeing_summaries collections exist in the DB.
    if (!db.users) {
      // If the users collection is missing (e.g. from an older database),
      // initialise it with the default users defined above.
      db.users = JSON.parse(JSON.stringify(defaultData.users));
    }
    if (!db.wellbeing_summaries) {
      db.wellbeing_summaries = [];
    }
    // Ensure multi‑tenant tables exist.  Older databases won't have these.
    if (!db.organisations) {
      db.organisations = JSON.parse(JSON.stringify(defaultData.organisations));
    }
    if (!db.organisation_billing) {
      db.organisation_billing = JSON.parse(JSON.stringify(defaultData.organisation_billing));
    }
    if (!db.payroll_records) {
      db.payroll_records = [];
    }
    if (!db.performance_metrics) {
      db.performance_metrics = [];
    }
    if (!db.reports) {
      db.reports = [];
    }
    if (!db.analytics_snapshots) {
      db.analytics_snapshots = [];
    }

    // Assign organisation_id to existing records if missing.  Default to the
    // first organisation (id=1) for backward compatibility.
    const defaultOrgId = (db.organisations && db.organisations[0] && db.organisations[0].id) || 1;
    ['shifts','staff','users','payroll_records','performance_metrics','reports','analytics_snapshots'].forEach(collection => {
      if (db[collection]) {
        db[collection].forEach(item => {
          if (typeof item.organisation_id === 'undefined') {
            item.organisation_id = defaultOrgId;
          }
        });
      }
    });

    // Ensure all staff members have a contracted_hours_per_week field.  If
    // missing, default to 40 hours per week.
    if (db.staff) {
      db.staff.forEach(staff => {
        if (typeof staff.contracted_hours_per_week === 'undefined') {
          // Use 37.5 hours per week as the default contracted hours.
          staff.contracted_hours_per_week = 37.5;
        }
      });
    }
    db.users.forEach(user => {
      if (!user.password_hash || user.password_hash.trim() === '') {
        let plain;
        // Set deterministic passwords for default users to simplify testing.
        if (user.email === 'admin@example.com') plain = 'adminpass';
        else if (user.email === 'staff@example.com') plain = 'staffpass';
        else plain = 'password';
        user.password_hash = hashPassword(plain);
      }
    });
    save();
  } catch (err) {
    console.error('Error initialising user passwords', err);
  }
})();

module.exports = {
  db,
  save,
  findRecord,
  getAll,
  insertRecord,
  updateRecord,
  removeRecord
};